<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RootsStay - Confirm Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: sans-serif;
        background-color: #f3f4f6; /* bg-gray-100 */
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  </head>
  <body class="bg-gray-100 font-sans flex flex-col min-h-screen">
    <button
      id="translateBtn"
      class="fixed top-4 right-4 bg-yellow-400 text-black px-4 py-2 rounded shadow hover:bg-yellow-500 z-50"
    >
      üåê Translate
    </button>

    <div
      id="translateModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50"
    >
      <div class="bg-white p-6 rounded-lg w-80 text-center">
        <h2 class="text-xl font-bold mb-4" id="modalTitle">Select Language</h2>
        <div class="space-y-2 text-left">
          <label class="flex items-center space-x-2">
            <input
              type="radio"
              name="language"
              value="en"
              class="form-radio text-green-600"
              checked
            />
            <span>English</span>
          </label>
          <label class="flex items-center space-x-2">
            <input
              type="radio"
              name="language"
              value="hi"
              class="form-radio text-green-600"
            />
            <span>‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</span>
          </label>
          <label class="flex items-center space-x-2">
            <input
              type="radio"
              name="language"
              value="kan"
              class="form-radio text-green-600"
            />
            <span>‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</span>
          </label>
        </div>
        <div class="mt-4 space-x-2">
          <button
            id="applyTranslate"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          >
            Apply
          </button>
          <button
            id="cancelTranslate"
            class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <header
      class="flex items-center justify-center py-6 bg-[rgba(22,101,52,0.95)] text-white relative"
    >
      <div class="absolute left-4 top-1/2 -translate-y-1/2">
        <a href="index.html">
          <img src="logo.jpg" alt="RootsStay Logo" class="h-16 w-auto" />
        </a>
      </div>
      <h1 id="headerTitle" class="text-2xl font-bold">Confirm Your Booking</h1>
    </header>

    <main class="flex-1 container mx-auto p-6 md:p-8">
      <div
        id="contentContainer"
        class="bg-white rounded-lg shadow-xl p-6 md:p-8 flex flex-col lg:flex-row gap-8"
      >
        <div class="lg:w-2/3">
          <h3
            class="text-2xl font-semibold text-green-700 mb-4"
            id="listingName"
          >
            Loading Homestay...
          </h3>
          <p class="text-gray-600 mb-2" id="listingLocation">Location: -</p>
          <p class="text-gray-600 mb-4" id="listingPrice">
            Price per night: ‚Çπ0
          </p>
          <img
            src="https://placehold.co/600x400/60a5fa/ffffff?text=Loading+Image"
            alt="Homestay Image"
            class="w-full h-64 object-cover rounded-lg mb-6 shadow-md"
            id="listingImage"
          />

          <h4 class="text-xl font-semibold mb-3" id="aboutStayTitle">
            About Your Stay
          </h4>
          <p class="text-gray-700 leading-relaxed" id="listingDescription">
            Fetching details...
          </p>
        </div>

        <div class="lg:w-1/3 bg-green-50 p-6 rounded-lg shadow-inner">
          <h3
            class="text-2xl font-semibold text-green-800 mb-4"
            id="bookingSummaryTitle"
          >
            Booking Summary
          </h3>

          <div class="mb-6">
            <label
              for="checkInDate"
              class="block text-gray-700 font-medium mb-2"
              id="checkInLabel"
              >Check-in Date:</label
            >
            <input
              type="text"
              id="checkInDate"
              class="w-full p-3 border border-green-300 rounded-md focus:ring-green-500 focus:border-green-500"
              placeholder="Select check-in date"
            />
          </div>

          <div class="mb-6">
            <label
              for="checkOutDate"
              class="block text-gray-700 font-medium mb-2"
              id="checkOutLabel"
              >Check-out Date:</label
            >
            <input
              type="text"
              id="checkOutDate"
              class="w-full p-3 border border-green-300 rounded-md focus:ring-green-500 focus:border-green-500"
              placeholder="Select check-out date"
            />
          </div>

          <div class="mb-6">
            <label
              for="numGuests"
              class="block text-gray-700 font-medium mb-2"
              id="guestsLabel"
              >Number of Guests:</label
            >
            <input
              type="number"
              id="numGuests"
              min="1"
              value="1"
              class="w-full p-3 border border-green-300 rounded-md focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <div class="border-t border-green-300 pt-4 mt-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-700" id="nightsText">Nights:</span>
              <span class="font-bold" id="totalNights">0</span>
            </div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-700" id="pricePerNightText"
                >Price per night:</span
              >
              <span class="font-bold" id="calculatedPricePerNight">‚Çπ0</span>
            </div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-700" id="subtotalText">Subtotal:</span>
              <span class="font-bold" id="subtotal">‚Çπ0</span>
            </div>
            <div
              class="flex justify-between items-center text-xl font-bold text-green-800 border-t border-green-600 pt-3 mt-3"
            >
              <span id="totalText">Total:</span>
              <span id="totalAmount">‚Çπ0</span>
            </div>
          </div>

          <button
            id="confirmBookingBtn"
            class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out text-lg font-semibold mt-8 shadow-md"
          >
            Confirm and Pay
          </button>
        </div>
      </div>
    </main>

    <footer id="footerText" class="text-center text-gray-600 py-4 bg-gray-200">
      ¬© 2025 RootsStay. Empowering Rural India.
    </footer>

    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"
    ></script>
    <script
      type="module"
      src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
    ></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // Firebase Configuration (USE YOUR ACTUAL CONFIG)
      const firebaseConfig = {
        apiKey: "AIzaSyCeNKQERwHDThmiNd1YUeogPVn6X0UKI4c",
        authDomain: "rootstay-f9335.firebaseapp.com",
        projectId: "rootstay-f9335",
        storageBucket: "rootstay-f9335.appspot.com",
        messagingSenderId: "997017904027",
        appId: "1:997017904027:web:24a2d07fa7a776a290773e",
        measurementId: "G-13HML9X5XH",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Get homestay ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const homestayId = urlParams.get("id"); // Using 'id' as per modified listings.html

      let currentHomestayPricePerNight = 0; // To store the numeric price for calculations

      // Initialize Flatpickr for date selection
      const checkInPicker = flatpickr("#checkInDate", {
        minDate: "today",
        dateFormat: "Y-m-d",
        onChange: function (selectedDates, dateStr, instance) {
          checkOutPicker.set(
            "minDate",
            selectedDates[0] ? new Date(selectedDates[0]).fp_incr(1) : "today"
          );
          calculateBill();
        },
      });

      const checkOutPicker = flatpickr("#checkOutDate", {
        minDate: new Date().fp_incr(1), // Default min date is tomorrow
        dateFormat: "Y-m-d",
        onChange: function (selectedDates, dateStr, instance) {
          checkInPicker.set(
            "maxDate",
            selectedDates[0] ? new Date(selectedDates[0]).fp_incr(-1) : null
          );
          calculateBill();
        },
      });

      const numGuestsInput = document.getElementById("numGuests");
      numGuestsInput.addEventListener("change", calculateBill);
      numGuestsInput.addEventListener("input", calculateBill); // Also listen to input for live updates

      // Function to fetch homestay details from Firestore
      async function fetchHomestayDetails(id) {
        if (!id) {
          document.getElementById(
            "contentContainer"
          ).innerHTML = `<p class="text-center text-red-500 text-2xl mt-20">No homestay selected. Please go back to listings.</p>`;
          return null;
        }

        try {
          const docRef = doc(db, "listings", id); // Reference to the specific document
          const docSnap = await getDoc(docRef); // Fetch the document

          if (!docSnap.exists()) {
            document.getElementById(
              "contentContainer"
            ).innerHTML = `<p class="text-center text-red-500 text-2xl mt-20">Homestay not found!</p>`;
            console.error("No such document!");
            return null;
          } else {
            const selectedHomestay = docSnap.data();

            // Extract numeric price from string (e.g., "‚Çπ2500/night")
            const priceMatch = selectedHomestay.price
              ? selectedHomestay.price.match(/‚Çπ(\d+)\/night/)
              : null;
            currentHomestayPricePerNight = priceMatch
              ? parseInt(priceMatch[1], 10)
              : 0;

            // Populate homestay details on the page
            document.getElementById("listingName").innerText =
              selectedHomestay.village ?? "Unknown Homestay";
            document.getElementById("listingLocation").innerText =
              "Location: " + (selectedHomestay.village ?? "N/A"); // Assuming village is location
            document.getElementById("listingPrice").innerText =
              "Price per night: " +
              (selectedHomestay.price ?? "Price not available");
            document.getElementById("listingImage").src =
              selectedHomestay.image ??
              "https://placehold.co/600x400/60a5fa/ffffff?text=No+Image";
            document.getElementById("listingDescription").innerText =
              selectedHomestay.description ?? "No description available.";
            document.getElementById("calculatedPricePerNight").innerText =
              "‚Çπ" + currentHomestayPricePerNight.toLocaleString("en-IN");

            // Initial calculation after details are loaded
            calculateBill();
            return selectedHomestay;
          }
        } catch (error) {
          console.error("Error fetching homestay details:", error);
          document.getElementById(
            "contentContainer"
          ).innerHTML = `<p class="text-center text-red-500 text-2xl mt-20">Error loading homestay details. Please try again later.</p>`;
          return null;
        }
      }

      // Function to calculate and update the bill
      function calculateBill() {
        const checkInDate = checkInPicker.selectedDates[0];
        const checkOutDate = checkOutPicker.selectedDates[0];
        const numGuests = parseInt(numGuestsInput.value) || 1; // Default to 1 guest if invalid

        let totalNights = 0;
        if (checkInDate && checkOutDate && checkOutDate > checkInDate) {
          const diffTime = Math.abs(checkOutDate - checkInDate);
          totalNights = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        const subtotal = currentHomestayPricePerNight * totalNights * numGuests;
        // const serviceFee = subtotal * 0.1; // 10% service fee - REMOVED
        const totalAmount = subtotal; // Total is now just subtotal

        document.getElementById("totalNights").innerText = totalNights;
        document.getElementById("subtotal").innerText =
          "‚Çπ" + subtotal.toLocaleString("en-IN");
        // document.getElementById("serviceFee").innerText = // REMOVED
        //   "‚Çπ" + serviceFee.toLocaleString("en-IN");
        document.getElementById("totalAmount").innerText =
          "‚Çπ" + totalAmount.toLocaleString("en-IN");
      }

      // Event listener for "Confirm and Pay" button
      document
        .getElementById("confirmBookingBtn")
        .addEventListener("click", () => {
          const checkIn = document.getElementById("checkInDate").value;
          const checkOut = document.getElementById("checkOutDate").value;
          const guests = document.getElementById("numGuests").value;
          const total = document.getElementById("totalAmount").innerText;

          if (checkIn && checkOut && guests > 0 && total !== "‚Çπ0") {
            alert(
              `Booking for ${
                document.getElementById("listingName").innerText
              } from ${checkIn} to ${checkOut} for ${guests} guests. Total: ${total}.` +
                "\n\n(In a real application, this would proceed to payment processing.)"
            );
            // In a real application:
            // 1. Send booking details to your Firebase backend (e.g., to a 'bookings' collection)
            // 2. Handle payment gateway integration
            // 3. Redirect to a confirmation page
          } else {
            alert(
              "Please select valid dates and number of guests to confirm your booking."
            );
          }
        });

      // --- Translation Logic (Copied from your existing files) ---
      const translateBtn = document.getElementById("translateBtn");
      const translateModal = document.getElementById("translateModal");
      const applyTranslate = document.getElementById("applyTranslate");
      const cancelTranslate = document.getElementById("cancelTranslate");

      translateBtn.addEventListener("click", () => {
        translateModal.classList.remove("hidden");
        translateModal.classList.add("flex");
      });

      cancelTranslate.addEventListener("click", () => {
        translateModal.classList.add("hidden");
        translateModal.classList.remove("flex");
      });

      applyTranslate.addEventListener("click", () => {
        const selectedLang = document.querySelector(
          'input[name="language"]:checked'
        ).value;
        localStorage.setItem("rootsstayLang", selectedLang); // Save language preference
        translateContent(selectedLang);
        translateModal.classList.add("hidden");
        translateModal.classList.remove("flex");
      });

      function translateContent(lang) {
        const translations = {
          en: {
            headerTitle: "Confirm Your Booking",
            modalTitle: "Select Language",
            aboutStayTitle: "About Your Stay",
            bookingSummaryTitle: "Booking Summary",
            checkInLabel: "Check-in Date:",
            checkOutLabel: "Check-out Date:",
            guestsLabel: "Number of Guests:",
            nightsText: "Nights:",
            pricePerNightText: "Price per night:",
            subtotalText: "Subtotal:",
            // serviceFeeText: "Service Fee (10%):", // REMOVED
            totalText: "Total:",
            confirmBookingBtn: "Confirm and Pay",
            footerText: "¬© 2025 RootsStay. Empowering Rural India.",
          },
          hi: {
            headerTitle: "‡§Ö‡§™‡§®‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç",
            modalTitle: "‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç",
            aboutStayTitle: "‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç",
            bookingSummaryTitle: "‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂",
            checkInLabel: "‡§ö‡•á‡§ï-‡§á‡§® ‡§§‡§ø‡§•‡§ø:",
            checkOutLabel: "‡§ö‡•á‡§ï-‡§Ü‡§â‡§ü ‡§§‡§ø‡§•‡§ø:",
            guestsLabel: "‡§Ö‡§§‡§ø‡§•‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ:",
            nightsText: "‡§∞‡§æ‡§§‡•á‡§Ç:",
            pricePerNightText: "‡§™‡•ç‡§∞‡§§‡§ø ‡§∞‡§æ‡§§ ‡§ï‡•Ä‡§Æ‡§§:",
            subtotalText: "‡§â‡§™‡§Ø‡•ã‡§ó:",
            // serviceFeeText: "‡§∏‡•á‡§µ‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï (10%):", // REMOVED
            totalText: "‡§ï‡•Å‡§≤:",
            confirmBookingBtn: "‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç",
            footerText: "¬© 2025 ‡§∞‡•Ç‡§ü‡•ç‡§∏‡§∏‡•ç‡§ü‡•á‡•§ ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£ ‡§≠‡§æ‡§∞‡§§ ‡§ï‡•ã ‡§∏‡§∂‡§ï‡•ç‡§§ ‡§¨‡§®‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§",
          },
          kan: {
            headerTitle: "‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤¨‡≥Å‡≤ï‡≤ø‡≤Ç‡≤ó‡≥ç ‡≤¶‡≥É‡≤¢‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø",
            modalTitle: "‡≤≠‡≤æ‡≤∑‡≥Ü ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø",
            aboutStayTitle: "‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤µ‡≤æ‡≤∏‡≥ç‡≤§‡≤µ‡≥ç‡≤Ø‡≤¶ ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü",
            bookingSummaryTitle: "‡≤¨‡≥Å‡≤ï‡≤ø‡≤Ç‡≤ó‡≥ç ‡≤∏‡≤æ‡≤∞‡≤æ‡≤Ç‡≤∂",
            checkInLabel: "‡≤ö‡≥Ü‡≤ï‡≥ç-‡≤á‡≤®‡≥ç ‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï:",
            checkOutLabel: "‡≤ö‡≥Ü‡≤ï‡≥ç-‡≤î‡≤ü‡≥ç ‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï:",
            guestsLabel: "‡≤Ö‡≤§‡≤ø‡≤•‡≤ø‡≤ó‡≤≥ ‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü:",
            nightsText: "‡≤∞‡≤æ‡≤§‡≥ç‡≤∞‡≤ø‡≤ó‡≤≥‡≥Å:",
            pricePerNightText: "‡≤™‡≥ç‡≤∞‡≤§‡≤ø ‡≤∞‡≤æ‡≤§‡≥ç‡≤∞‡≤ø‡≤ó‡≥Ü ‡≤¨‡≥Ü‡≤≤‡≥Ü:",
            subtotalText: "‡≤â‡≤™‡≤Æ‡≥ä‡≤§‡≥ç‡≤§:",
            // serviceFeeText: "‡≤∏‡≥á‡≤µ‡≤æ ‡≤∂‡≥Å‡≤≤‡≥ç‡≤ï (10%):", // REMOVED
            totalText: "‡≤í‡≤ü‡≥ç‡≤ü‡≥Å:",
            confirmBookingBtn: "‡≤¶‡≥É‡≤¢‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤™‡≤æ‡≤µ‡≤§‡≤ø‡≤∏‡≤ø",
            footerText:
              "¬© 2025 ‡≤∞‡≥Ç‡≤ü‡≥ç‚Äå‡≤∏‡≥ç‡≤ü‡≥á. ‡≤ó‡≥ç‡≤∞‡≤æ‡≤Æ‡≥Ä‡≤£ ‡≤≠‡≤æ‡≤∞‡≤§‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤∂‡≤ï‡≥ç‡≤§‡≤ø‡≤∂‡≤æ‡≤≤‡≤ø‡≤Ø‡≤æ‡≤ó‡≤ø‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü.",
          },
        };

        const t = translations[lang];
        document.getElementById("headerTitle").innerText = t.headerTitle;
        document.getElementById("modalTitle").innerText = t.modalTitle;
        document.getElementById("aboutStayTitle").innerText = t.aboutStayTitle;
        document.getElementById("bookingSummaryTitle").innerText =
          t.bookingSummaryTitle;
        document.getElementById("checkInLabel").innerText = t.checkInLabel;
        document.getElementById("checkOutLabel").innerText = t.checkOutLabel;
        document.getElementById("guestsLabel").innerText = t.guestsLabel;
        document.getElementById("nightsText").innerText = t.nightsText;
        document.getElementById("pricePerNightText").innerText =
          t.pricePerNightText;
        document.getElementById("subtotalText").innerText = t.subtotalText;
        // document.getElementById("serviceFeeText").innerText = t.serviceFeeText; // REMOVED
        document.getElementById("totalText").innerText = t.totalText;
        document.getElementById("confirmBookingBtn").innerText =
          t.confirmBookingBtn;
        document.getElementById("footerText").innerText = t.footerText;
      }

      // Call translation on page load to apply default or last-selected language
      document.addEventListener("DOMContentLoaded", () => {
        const savedLang = localStorage.getItem("rootsstayLang") || "en";
        document.querySelector(
          `input[name="language"][value="${savedLang}"]`
        ).checked = true;
        translateContent(savedLang);
        fetchHomestayDetails(homestayId); // Fetch data after DOM is ready and translation is set
      });
    </script>
  </body>
</html>
